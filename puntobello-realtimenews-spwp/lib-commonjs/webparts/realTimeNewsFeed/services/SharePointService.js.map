{"version":3,"file":"SharePointService.js","sourceRoot":"","sources":["../../../../src/webparts/realTimeNewsFeed/services/SharePointService.ts"],"names":[],"mappings":"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","sourcesContent":["// SPFx Core Libraries\nimport { ServiceKey, ServiceScope } from \"@microsoft/sp-core-library\";\nimport { PageContext } from \"@microsoft/sp-page-context\";\n\n// PnP SP Libraries\nimport \"@pnp/sp/webs\";\nimport \"@pnp/sp/site-users/web\";\nimport \"@pnp/sp/lists\";\nimport \"@pnp/sp/items\";\nimport \"@pnp/sp/profiles\";\nimport \"@pnp/sp/regional-settings/web\";\nimport { SPFI, spfi, SPFx } from \"@pnp/sp\";\nimport { dateAdd, PnPClientStorage } from \"@pnp/core\";\n// IItemAddResult has been removed in PnP v4, using built-in types\n// import { IItemAddResult } from \"@pnp/sp/items\";\n\n// PnP Graph Libraries for taxonomy\nimport \"@pnp/graph/taxonomy\";\nimport { graphfi, GraphFI, SPFx as GraphSPFx } from \"@pnp/graph\";\n// IOrderedTermInfo interface may have changed in PnP v4\n// Using any[] for now to preserve functionality\n// import { IOrderedTermInfo } from \"@pnp/graph/taxonomy\";\nimport { AadTokenProviderFactory } from \"@microsoft/sp-http\";\n\n// Utility Libraries\nimport { Logger, getRootEnv } from '../utils';\nimport * as lcid from \"lcid\";\n\n// Models and Interfaces\nimport { \n    INewsItemsResult, \n    INewsItemData, \n    ILanguageRepresentation, \n    IPageContext, \n    IRootEnv, \n    IChannels2SubsItem, \n    IChannels2SubscriptionItem \n} from \"../models\";\n\n/**\n * Interface representing the SharePoint Service.\n * This interface defines methods for interacting with SharePoint data, such as retrieving and caching channels,\n * getting news items, managing user subscriptions, and handling multilingual support.\n */\nexport interface ISharePointService {\n    /**\n     * Sets the SPFx context and initializes the PnP SP instance.\n     * @param {any} context - The full SPFx context (e.g., WebPartContext)\n     */\n    setContext(context: any): void;\n\n    /**\n     * Retrieves and caches all available channels from SharePoint Term Store.\n     * @returns {Promise<IOrderedTermInfo[]>} A promise that resolves with an array of ordered term information.\n     */\n    getAndCacheAllChannels(): Promise<any[]>;\n\n    /**\n     * Gets the subscribed channels for the current user from SharePoint.\n     * @returns {Promise<IChannels2SubsItem[]>} A promise that resolves with an array of subscribed channels.\n     */\n    getSubscribedChannels4CurrentUser(): Promise<IChannels2SubsItem[]>;\n\n    /**\n     * Retrieves the page context for a specific list item in SharePoint.\n     * This method is used to determine the language settings for the page, specifically when running in a multilingual setup.\n     * If we are not running in a multilingual setup, it will automatically throw an error (ODATA__ fields not present) which should be caught and handled by the caller.\n     * @param {string} listId - The ID of the SharePoint list.\n     * @param {number} listItemId - The ID of the list item.\n     * @returns {Promise<IPageContext>} A promise that resolves with the page context of the specified list item.\n     */\n    getPageContext(listId: string, listItemId: number): Promise<IPageContext>;\n\n    /**\n     * Adds a new subscribed channels entry for the current user in SharePoint.\n     * @returns {Promise<IItemAddResult>} A promise that resolves with the result of the item addition.\n     */\n    addSubscribedChannels4CurrentUser(): Promise<any>;\n\n    /**\n     * Retrieves news items for the specified channel or channels in SharePoint.\n     * @param {string} newsChannelCurrent - The current news channel.\n     * @param {string} newsGuid - The GUID of the news.\n     * @param {IChannels2SubscriptionItem[]} newsChannels - An array of subscription items for the news channels.\n     * @param {ILanguageRepresentation} pageLanguage - The language representation for the page.\n     * @param {number} newsCount - The number of news items to retrieve.\n     * @returns {Promise<INewsItemsResult>} A promise that resolves with the news items result.\n     */\n    getNewsItems(newsChannelCurrent: string, newsGuid: string, newsChannels: IChannels2SubscriptionItem[], pageLanguage: ILanguageRepresentation, newsCount: number): Promise<INewsItemsResult>;\n\n    /**\n     * Checks if a news item is valid based on its ID.\n     * @param {number} id - The ID of the news item.\n     * @returns {Promise<boolean>} A promise that resolves with a boolean indicating whether the news item is valid.\n     */\n    checkValidNewsItem(id: number): Promise<boolean>;\n\n    /**\n     * Updates multiple metadata fields for a SharePoint list item.\n     * @param {any[]} terms - An array of terms representing the metadata to update.\n     * @param {string} listName - The name of the SharePoint list.\n     * @param {string} fieldName - The name of the metadata field to update.\n     * @param {number} itemId - The ID of the list item to update.\n     * @returns {Promise<any>} A promise that resolves with the result of the update operation.\n     */\n    updateMultiMeta(terms: any[], listName: string, fieldName: string, itemId: number): Promise<any>;\n\n    /**\n     * Calculates the language settings for a SharePoint page based on its context.\n     * @param {string} listId - The ID of the SharePoint list.\n     * @param {number} listItemId - The ID of the list item.\n     * @param {number} defaultLanguage - The default language LCID (Locale ID).\n     * @returns {Promise<ILanguageRepresentation>} A promise that resolves with the language representation.\n     */\n    calculateLanguage(listId: string, listItemId: number, defaultLanguage: number): Promise<ILanguageRepresentation>;\n\n    /** \n     * A filter query string used for socket operations.\n     * @type {string}\n     */\n    filterQuery4Socket: string;\n\n    /** \n     * The SharePoint Framework Interface instance.\n     * @type {SPFI}\n     */\n    sp: SPFI;\n}\n\n/**\n * SharePointService class provides methods to interact with SharePoint data, including channels, user subscriptions,\n * news items, and language settings. It implements the ISharePointService interface.\n */\nexport default class SharePointService implements ISharePointService {\n    public static readonly serviceKey: ServiceKey<ISharePointService> =\n        ServiceKey.create<ISharePointService>('SPFx:SharePointService', SharePointService);\n\n    private storage!: PnPClientStorage;\n    private pageContext!: PageContext;\n    private logger: Logger;\n    private rootEnv!: IRootEnv;\n    public filterQuery4Socket!: string;\n    public sp!: SPFI;\n    private graph!: GraphFI;\n    private spfxContext: any; // Store the full SPFx context\n\n    /**\n     * Initializes a new instance of the SharePointService class.\n     * @param {ServiceScope} serviceScope - The service scope used to resolve dependencies.\n     */\n    constructor(serviceScope: ServiceScope) {\n        this.logger = Logger.getInstance();\n\n        serviceScope.whenFinished(() => {\n            this.pageContext = serviceScope.consume(PageContext.serviceKey);\n            this.storage = new PnPClientStorage();\n            this.rootEnv = getRootEnv();\n\n            // Note: SP instance will be initialized later with the full context via setContext()\n            // Initialize Graph API for termStore access\n            const aadTokenProviderFactory = serviceScope.consume(AadTokenProviderFactory.serviceKey);\n            this.graph = graphfi().using(GraphSPFx({aadTokenProviderFactory: aadTokenProviderFactory}));\n        });\n    }\n\n    /**\n     * Sets the SPFx context and initializes the PnP SP instance.\n     * This must be called before using any SP operations.\n     * @param {any} context - The full SPFx context (e.g., WebPartContext)\n     */\n    public setContext(context: any): void {\n        this.spfxContext = context;\n        // In PnP v4, SPFx behavior factory expects the full context object\n        this.sp = spfi().using(SPFx(context));\n    }\n\n    /**\n     * Retrieves the page context for a specific list item in SharePoint.\n     * This method is used to determine the language settings for the page, specifically when running in a multilingual setup.\n     * If we are not running in a multilingual setup, it will automatically throw an error (ODATA__ fields not present) which should be caught and handled by the caller.\n     * @param {string} listId - The ID of the SharePoint list.\n     * @param {number} listItemId - The ID of the list item.\n     * @returns {Promise<IPageContext>} A promise that resolves with the page context of the specified list item.\n     */\n    public getPageContext = async (listId: string, listItemId: number): Promise<IPageContext> => {\n        const context: IPageContext = await this.sp.web.lists.getById(listId)\n            .items\n            .getById(listItemId)\n            .select(\n                'OData__SPIsTranslation',\n                'OData__SPTranslationLanguage',\n                'OData__SPTranslationSourceItemId')();\n        return context;\n    }\n\n    /**\n     * Retrieves and caches all available channels from the SharePoint Term Store.\n     * Termstore guids are fix for PuntoBello\n     * @returns {Promise<IOrderedTermInfo[]>} A promise that resolves with an array of ordered term information.\n     */\n    public async getAndCacheAllChannels(): Promise<any[]> {\n        const termStoreGuid4Channels = getRootEnv().config.spfxTermstoreChannelGuid;\n        return await this.storage.local.getOrPut<any[]>(`pb_channels_${termStoreGuid4Channels}`, () => {\n            return this.graph.termStore.sets.getById(`${termStoreGuid4Channels}`).getAllChildrenAsTree();\n        }, dateAdd(new Date(), 'hour', 12));\n    }\n\n    /**\n     * Gets the subscribed channels for the current user from SharePoint.\n     * @returns {Promise<IChannels2SubsItem[]>} A promise that resolves with an array of subscribed channels.\n     */\n    public async getSubscribedChannels4CurrentUser(): Promise<IChannels2SubsItem[]> {\n        return await this.sp.web.lists.getByTitle(this.rootEnv.config.spfxSubscribedChannelsListTitle ?? '').items\n            .filter(\"pb_Subscriber eq '\" + this.pageContext.legacyPageContext.userId + \"'\")\n            .select(\"Id\", \"pb_Channels\").top(1)();\n    }\n\n    /**\n     * Adds a new subscribed channels entry for the current user in SharePoint.\n     * @returns {Promise<IItemAddResult>} A promise that resolves with the result of the item addition.\n     */\n    public async addSubscribedChannels4CurrentUser(): Promise<any> {\n        return await this.sp.web.lists.getByTitle(this.rootEnv.config.spfxSubscribedChannelsListTitle ?? '').items.add({\n            Title: this.pageContext.legacyPageContext.DisplayName,\n            pb_SubscriberId: this.pageContext.legacyPageContext.userId\n        });\n    }\n\n    /**\n     * Retrieves news items for the specified channel or channels in SharePoint.\n     * @param {string} newsChannelCurrent - The current news channel.\n     * @param {string} newsGuid - The GUID of the news.\n     * @param {IChannels2SubscriptionItem[]} newsChannels - An array of subscription items for the news channels.\n     * @param {ILanguageRepresentation} pageLanguage - The language representation for the page.\n     * @param {number} newsCount - The number of news items to retrieve.\n     * @returns {Promise<INewsItemsResult>} A promise that resolves with the news items result.\n     */\n    public getNewsItems(newsChannelCurrent: string, newsGuid: string, newsChannels: IChannels2SubscriptionItem[], pageLanguage: ILanguageRepresentation, newsCount: number): Promise<INewsItemsResult> {\n        const p = new Promise<INewsItemsResult>((resolve, reject) => {\n            const newsResult: INewsItemsResult = {\n                newsItemData: [],\n                sticky: false\n            };\n            // build filter for channels\n            let channelFilter: string;\n            if (newsChannelCurrent === newsGuid) {\n                channelFilter = this.filterBuilder(\"pb_Channels\",\n                    newsChannels\n                        .filter((channel: IChannels2SubscriptionItem) => { if (channel.Subscribed && channel.TermGuid != newsGuid) return channel; })\n                        .map(channel => channel.TermGuid), false);\n            } else {\n                channelFilter = this.filterBuilder(\"pb_Channels\", Array.from(new Set([newsChannelCurrent])), false);\n            }\n\n            const currDate = this.toISOStringWithTimezone(new Date());\n            const publishingDatesFilter = `pb_PublishedFrom le datetime'${currDate}' and (pb_PublishedTo ge datetime'${currDate}' or pb_PublishedTo eq null)`;\n\n            const filterQuery = channelFilter + \" and (pb_Language eq '\" + pageLanguage.LanguageDashedLC + \"' or pb_Language eq '\" + pageLanguage.lcid + \"') and \" + publishingDatesFilter;\n            const filterQuerySocket = channelFilter + \" and (pb_Language eq '\" + pageLanguage.LanguageDashedLC + \"' or pb_Language eq '\" + pageLanguage.lcid + \"') and \";\n            this.filterQuery4Socket = filterQuerySocket;\n\n            // Check if we have a sticky news which sticky date has been reached\n            newsResult.sticky = false;\n            const filterQuerySticky = filterQuery + ` and (pb_Sticky eq 1 and pb_StickyDate le datetime'${currDate}')`;\n            const filterQueryWithoutSticky = filterQuery + ` and ((pb_Sticky eq 0 or pb_Sticky eq null) or (pb_Sticky eq 1 and pb_StickyDate ge datetime'${currDate}'))`;\n            this.sp.web.lists.getById(this.rootEnv.config.spfxRealtimenewsListId ?? '').items.filter(filterQuerySticky).top(1)().then((item) => {\n                if (item.length > 0) {\n                    newsResult.sticky = true;\n                    newsResult.newsItemData.push(item[0] as INewsItemData);\n                } else {\n                    newsResult.sticky = false;\n                }\n                this.sp.web.lists.getById(this.rootEnv.config.spfxRealtimenewsListId ?? '').items.filter(filterQueryWithoutSticky).orderBy(\"pb_PublishedFrom\", false).top(newsCount)().then((items) => {\n                    newsResult.newsItemData.push(...items);\n                    resolve(\n                        newsResult\n                    );\n                }).catch((error) => {\n                    this.logger.error('GET_NEWS_WITH_STICKY', error);\n                    reject(error);\n                });\n            });\n        });\n        return p;\n    }\n\n    /**\n     * Checks if a news item is valid based on its ID.\n     * @param {number} id - The ID of the news item.\n     * @returns {Promise<boolean>} A promise that resolves with a boolean indicating whether the news item is valid.\n     */\n    public async checkValidNewsItem(id: number): Promise<boolean> {\n        const currDate = this.toISOStringWithTimezone(new Date());\n        const publishingDatesFilter = `pb_PublishedFrom le datetime'${currDate}' and (pb_PublishedTo ge datetime'${currDate}' or pb_PublishedTo eq null)`;\n\n        const currentFilter = this.filterQuery4Socket + publishingDatesFilter + ' and (Id eq ' + id.toString() + ')';\n        const item = await this.sp.web.lists.getById(this.rootEnv.config.spfxRealtimenewsListId ?? '').items.filter(currentFilter).top(1)();\n        if (item) return true;\n        return false;\n    }\n\n    /**\n     * Updates multiple metadata fields for a SharePoint list item.\n     * @param {any[]} terms - An array of terms representing the metadata to update.\n     * @param {string} listName - The name of the SharePoint list.\n     * @param {string} fieldName - The name of the metadata field to update.\n     * @param {number} itemId - The ID of the list item to update.\n     * @returns {Promise<any>} A promise that resolves with the result of the update operation.\n     */\n    public async updateMultiMeta(terms: any[], listName: string, fieldName: string, itemId: number): Promise<any> {\n        const list = await this.sp.web.lists.getByTitle(listName);\n        let termsString: string = '';\n        terms.forEach(term => {\n            termsString += `${term.termName}|${term.termGUID};`;\n        });\n        const updateValue = { FieldName: fieldName, FieldValue: termsString };\n\n        return await list.items.getById(itemId).validateUpdateListItem([updateValue]);\n    }\n\n    /**\n     * Builds a filter query string for SharePoint list items.\n     * @param {string} fieldName - The name of the field to filter by.\n     * @param {string[]} guids - An array of GUIDs to include in the filter.\n     * @param {boolean} truncate - Whether to truncate the GUIDs before building the filter.\n     * @returns {string} A filter query string.\n     */\n    private filterBuilder(fieldName: string, guids: string[], truncate: boolean): string {\n        let retVal: string;\n        if (truncate) {\n            guids.forEach((guid, i) => {\n                guids[i] = guids[i].split('-')[0];\n            });\n        }\n\n        if (guids.length === 1) {\n            return \"substringof('\" + guids[0] + \"',\" + fieldName + \")\";\n        } else {\n            retVal = guids.join(\"',\" + fieldName + \") or substringof('\");\n            return \"(substringof('\" + retVal + \"',\" + fieldName + \"))\";\n        }\n    }\n\n    /**\n     * Converts a date to an ISO string with timezone information.\n     * @param {Date} date - The date to convert.\n     * @returns {string} An ISO string representing the date with timezone information.\n     */\n    private toISOStringWithTimezone(date: Date): string {\n        const tzOffset = -date.getTimezoneOffset();\n        const diff = tzOffset >= 0 ? '+' : '-';\n        const pad = (n: number): string => {\n            const str = `${Math.floor(Math.abs(n))}`;\n            return str.length < 2 ? '0' + str : str;\n        };\n        return date.getFullYear() +\n            '-' + pad(date.getMonth() + 1) +\n            '-' + pad(date.getDate()) +\n            'T' + pad(date.getHours()) +\n            ':' + pad(date.getMinutes()) +\n            ':' + pad(date.getSeconds()) +\n            diff + pad(tzOffset / 60) +\n            ':' + pad(tzOffset % 60);\n    }\n\n    /**\n     * Calculates the language settings for a SharePoint page based on its context.\n     * @param {string} listId - The ID of the SharePoint list.\n     * @param {number} listItemId - The ID of the list item.\n     * @param {number} defaultLanguage - The default language LCID (Locale ID).\n     * @returns {Promise<ILanguageRepresentation>} A promise that resolves with the language representation.\n     */\n    public calculateLanguage = async (listId: string, listItemId: number, defaultLanguage: number): Promise<ILanguageRepresentation> => {\n        let pageContext = null;\n        const languageData: ILanguageRepresentation = {\n            lcid: 0, \n            Language: '',\n            LanguageLC: '',\n            LanguageDashed: '',\n            LanguageDashedLC: '',\n          };\n        try {\n            pageContext = await this.getPageContext(listId, listItemId);\n        } catch (error) {\n            this.logger.info(\"calculateLanguage, getPageContext returned an error, probably not running in a multilingual setup, defaulting to web language\", error);\n        }\n        if (!pageContext || !pageContext.OData__SPIsTranslation || !pageContext.OData__SPTranslationLanguage) {\n            // Not running in a multilingual setup\n            // Get language from web\n            languageData.lcid = defaultLanguage;\n            languageData.Language = lcid.from(defaultLanguage) ?? '';\n            languageData.LanguageLC = languageData.Language.toLowerCase();\n            languageData.LanguageDashed = languageData.Language.replace('_','-');\n            languageData.LanguageDashedLC = languageData.LanguageLC.replace('_','-');\n            return languageData;\n        }\n        // Page is a translation\n        // Get language from page property\n        languageData.Language = pageContext.OData__SPTranslationLanguage.replace(\"-\", \"_\").toLowerCase().replace(/(^\\w{2})/, (match) => match.toLowerCase()).replace(/(_\\w{2})$/, (match) => match.toUpperCase());\n        languageData.lcid = lcid.to(languageData.Language) ?? 0;\n        languageData.LanguageLC = languageData.Language.toLowerCase();\n        languageData.LanguageDashed = languageData.Language.replace('_','-');\n        languageData.LanguageDashedLC = languageData.LanguageLC.replace('_','-');\n        return languageData;\n    }\n}\n"]}