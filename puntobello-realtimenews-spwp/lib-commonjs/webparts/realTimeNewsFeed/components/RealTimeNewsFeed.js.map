{"version":3,"file":"RealTimeNewsFeed.js","sourceRoot":"","sources":["../../../../src/webparts/realTimeNewsFeed/components/RealTimeNewsFeed.tsx"],"names":[],"mappings":"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","sourcesContent":["// React imports for building components and handling state, refs, and effects\nimport * as React from 'react';\nimport { useRef, useState, useEffect } from 'react';\n\n// Fluent UI components and styles for the UI layout and spinner\nimport { Spinner, Stack } from '@fluentui/react';\n\n// Socket.IO client for real-time communication\nimport io from 'socket.io-client';\n\n// Component-specific styles\nimport styles from '../RealTimeNewsFeed.module.scss';\n\n// Component imports for various parts of the RealTimeNewsFeed feature\nimport { CommandBarNewsFeed } from './CommandBarNewsFeed';\nimport { StickyItem } from './StickyItem';\nimport { ChannelSettings } from './ChannelSettings';\nimport { NewsItem } from './NewsItem';\nimport { SystemMessage } from './SystemMessage';\n\n// Utility functions for UI and environment configuration\nimport { getEditedDate, getRootEnv, Utility } from '../utils';\n\n// Utility functions for real-time news feed processing and interactions\nimport {\n  processSocketEvent,\n  processSocketAddEvent,\n  processSocketErrorEvent,  \n  getAllData,\n  changeChannelSettings,\n  getAvailableItems,\n  getChannelDD\n} from '../utils';\n\n// SharePoint service for interacting with SharePoint APIs\nimport SharePointService from '../services/SharePointService';\n\n// Context for managing and accessing application-wide state\nimport { useAppContext } from '../contexts/AppContext';\n\n/**\n * The `RealTimeNewsFeed` component is responsible for rendering a real-time news feed in a SharePoint web part.\n * It connects to a WebSocket server, listens for updates, and manages the state and display of news items.\n * \n * This component leverages the SharePoint Framework (SPFx) and Fluent UI for styling and UI components.\n * It also makes use of context to access necessary services and settings, such as logging and theming.\n */\nexport function RealTimeNewsFeed() {\n  // Destructuring context values using the custom hook\n  const { context, logger, pageLanguage, newsCount, themeVariant } = useAppContext();\n\n  // Consume the SharePoint service from the service scope\n  const spo = context.serviceScope.consume(SharePointService.serviceKey);\n\n  // Retrieve environment settings\n  const rootEnv = getRootEnv();\n\n  // Refs to maintain stateful values between renders without causing re-renders\n  // Holds the fake GUID for the my news channel which shows all news for the channels subscribed by the user\n  const myNewsGuidRef = useRef(\"00000000-0000-0000-0000-000000000000\");\n  // Holds the current selected news channel, is initialzed with my News\n  const newsChannelCurrentRef = useRef(myNewsGuidRef.current);\n  // Holds all available news channels\n  const newsChannelsRef = useRef([]);\n  // List item with the channel configuration for the current user\n  const channelsubItemIdRef = useRef<number>();\n  // Sticky news present or not\n  const stickyRef = useRef(false);\n  // All news items to be showed\n  const newsItemsRef = useRef<any[]>([]);\n  // Number of new news items which are not yet displayed and shown in the system message\n  const numberOfNewNewsRef = useRef<number>(0);\n  // Track pending timeouts for cleanup on unmount (prevents memory leaks and stale callbacks)\n  const pendingTimeoutsRef = useRef<Map<string, ReturnType<typeof setTimeout>>>(new Map());\n\n  // State variables to manage loading, modal visibility, and system message visibility\n  const [loading, setLoading] = useState(true);\n  const [modalVisible, setModalVisible] = useState(false);\n  const [systemMessageVisible, setSystemMessageVisible] = useState(false);\n\n  // Combined styles incorporating theming and environment-specific styles\n  const combinedStyles = Object.assign(\n    {\n      backgroundColor: themeVariant?.semanticColors?.bodyBackground,\n      color: themeVariant?.semanticColors?.bodyText\n    },\n    getRootEnv().css\n  );\n\n  // useEffect hook to handle socket connections and data fetching on component mount\n  useEffect(() => {\n    // Establish a WebSocket connection\n    const socket = io(rootEnv.config.spfxSocketUrl ?? '', { transports: [\"websocket\"], timeout: +(getRootEnv().config.spfxSocketTimeoutInMs ?? 0) });\n\n    // Event listeners for WebSocket connection lifecycle and data events\n    socket.on(\"connect\", () => {\n      logger.info('Socket Connect, SocketId:' + socket.id);\n    });\n\n    // Process socket event received from the webapp server\n    socket.on(\"nd\", (data) => {\n      processSocketEvent(data, spo, numberOfNewNewsRef, setSystemMessageVisible, pendingTimeoutsRef, processSocketAddEvent, processSocketErrorEvent, updateNews);\n    });\n\n    socket.on(\"disconnect\", () => {\n      logger.info('Socket Disconnect, SocketId:' + socket.id);\n    });\n\n    socket.on(\"connect_error\", (socketerr) => {\n      logger.warn('Socket_error SocketId' + socket.id + 'error ' + socketerr);\n    });\n\n    // Fetch initial data for the news feed\n    getAllData(spo, newsChannelCurrentRef, myNewsGuidRef, newsChannelsRef, pageLanguage, newsCount, setLoading, newsItemsRef, stickyRef, channelsubItemIdRef);\n\n    // Clean up the socket connection and pending timeouts when the component unmounts\n    return () => {\n      socket.off();\n      // Clear all pending timeouts to prevent memory leaks and stale callbacks\n      pendingTimeoutsRef.current.forEach((timeout) => clearTimeout(timeout));\n      pendingTimeoutsRef.current.clear();\n    };\n  }, []);\n\n  // Function to update the news feed when new items are available\n  function updateNews() {\n    setSystemMessageVisible(false);\n    numberOfNewNewsRef.current = 0;\n    getAvailableItems(spo, newsChannelCurrentRef, myNewsGuidRef, newsChannelsRef, pageLanguage, newsCount, newsItemsRef, stickyRef, setLoading, logger);\n  }\n\n  // Function to handle channel changes and update the displayed news items\n  function channelChange(ddKey: string | number | undefined) {\n    newsChannelCurrentRef.current = String(ddKey ?? '');\n    getAvailableItems(spo, newsChannelCurrentRef, myNewsGuidRef, newsChannelsRef, pageLanguage, newsCount, newsItemsRef, stickyRef, setLoading, logger);\n  }\n\n  // Function to show the channel settings modal\n  function showChannelSettings() {\n    setModalVisible(true);\n  }\n\n  // Function to hide the channel settings modal and refresh the news items\n  function hideChannelSettings() {\n    getAvailableItems(spo, newsChannelCurrentRef, myNewsGuidRef, newsChannelsRef, pageLanguage, newsCount, newsItemsRef, stickyRef, setLoading, logger);\n    setModalVisible(false);\n  }\n\n  return (\n    <>\n      {/* Show a loading spinner while data is being fetched */}\n      {loading && <Spinner label={Utility.getStringTranslation4Locale('loading', pageLanguage.Language)} />}\n      \n      {/* Display the news feed once loading is complete */}\n      {!loading &&\n        <div className={styles.newsFeed} style={combinedStyles}>\n          {/* Display a system message if new news items are available */}\n          {systemMessageVisible && <SystemMessage Title={Utility.getStringTranslation4Locale('NewNewsAvailableLabel', pageLanguage.Language)} buttonUpdateNewsClicked={updateNews} />}\n          \n          {/* Highlight the first news item if it is marked as \"sticky\" */}\n          {stickyRef.current &&\n            <div className={styles.highlightContainer}>\n              <StickyItem NewsUrl={newsItemsRef.current[0].pb_NewsUrl.Url} ImageUrl={newsItemsRef.current[0].pb_ImageUrl} NewsTitle={newsItemsRef.current[0].Title} PublishedFrom={getEditedDate(newsItemsRef.current[0].pb_PublishedFrom)} NewsHeader={newsItemsRef.current[0].pb_Header}/>\n            </div>\n          }\n          \n          {/* Render the channel settings and command bar */}\n          <ChannelSettings myNewsGuid={myNewsGuidRef.current} channelsConfig={newsChannelsRef.current} modalVisible={modalVisible} modalSettingsTitle={Utility.getStringTranslation4Locale('modalSettingsTitle', pageLanguage.Language)} closeModal={hideChannelSettings} changeChannelSettings={(item: any, ev: any, isChecked: boolean) => changeChannelSettings(spo, newsChannelsRef, item, isChecked, channelsubItemIdRef)} />\n          <CommandBarNewsFeed channelDropdown={getChannelDD(newsChannelsRef, myNewsGuidRef, pageLanguage)} selectedKey={newsChannelCurrentRef.current} channelDropdownChanged={channelChange} channelSettingsModalClicked={showChannelSettings}/>\n          \n          {/* Display the list of news items, or a message if no items are available */}\n          {newsItemsRef.current.length > 0 ?\n            <Stack tokens={{ childrenGap: 14 }} className={styles.newsletterList}>\n              {newsItemsRef.current.map((currnews, index) => (\n                (index == 0 && stickyRef.current) ? <></> :\n                  <NewsItem key={currnews.Id || index} NewsUrl={currnews.pb_NewsUrl.Url} ImageUrl={currnews.pb_ImageUrl} NewsTitle={currnews.Title} PublishedFrom={getEditedDate(currnews.pb_PublishedFrom)} NewsHeader={currnews.pb_Header}/>\n              ))}\n            </Stack>\n            : <h2>{Utility.getStringTranslation4Locale('noNewsText', pageLanguage.Language)}</h2>}\n        </div >\n      }\n    </>\n  );\n}\n\n"]}